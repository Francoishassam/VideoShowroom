<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="styleSSAI.css" />
        <!-- Load Didomi for Consent Management -->
        <script async=false src="http://demo.smartadserver.com/shared/fgh/hb_outstream/didomi_config.js"></script>
        <!-- Load jqury library -->
        <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
        <title>Smart Video SSAI Showcase w/ Mediatailor</title>
    </head>
    <body>
        <div class="header" onclick="location.href='http://demo.smartadserver.com/shared/fgh/ssai/ssai.html';">
            <div>Smart Video SSAI Showcase using Mediatailor</div>
        </div>
        <div class="sectionsPanel">
            <div class="sectionChoice">
                1. Choose Streaming Profile    
                <select id="streamSelect" name="choice">
                    <option selected="selected"></option>
                    <optgroup label="Video On Demand VAST">
                        <option value="https://d3uu0ayyro5kdx.cloudfront.net/v1/master/36e2f8afe48d8956c4c9668bdd5ad7cf3cadafd5/HLS_VAST/AppleHLS1/flame-bao.2018.1080p.bluray.x264.m3u8?aws.logMode=DEBUG&ads.site=356853&ads.page=1469316&ads.fmt=29827&ads.ps=&ads.madb=30&ads.ssar=0&ads.ctd=&ads.tgt=&ads.uid=">HLS - SSAI - Flame Bao</option>
                        <option value="https://d3uu0ayyro5kdx.cloudfront.net/v1/master/36e2f8afe48d8956c4c9668bdd5ad7cf3cadafd5/HLS_VAST/AppleHLS2/The_Crush_VOD.m3u8?aws.logMode=DEBUG&ads.site=356853&ads.page=1469316&ads.fmt=29827&ads.ps=&ads.madb=30&ads.ssar=0&ads.ctd=&ads.tgt=&ads.uid=">HLS - SSAI - The Crush</option>
                        <option value="https://d3tsgrf86zqsco.cloudfront.net/v1/dash/36e2f8afe48d8956c4c9668bdd5ad7cf3cadafd5/DASH_VAST/DASH06/flame_bao.mpd?aws.logMode=DEBUG&ads.site=356853&ads.page=1469316&ads.fmt=29827&ads.ps=&ads.madb=30&ads.ssar=0&ads.ctd=&ads.tgt=&ads.uid=">DASH - SSAI - Flame Bao</option>
                        <option value="https://d3tsgrf86zqsco.cloudfront.net/v1/dash/36e2f8afe48d8956c4c9668bdd5ad7cf3cadafd5/DASH_VAST/DASH09/The_Crush_VOD.mpd?aws.logMode=DEBUG&ads.site=356853&ads.page=1469316&ads.fmt=29827&ads.ps=&ads.madb=30&ads.ssar=0&ads.ctd=&ads.tgt=&ads.uid=">DASH - SSAI - The Crush</option>
                    </optgroup>
                    <optgroup label="Video On Demand VMAP">
                        <option value="https://d9g2cvf59hfzx.cloudfront.net/v1/master/36e2f8afe48d8956c4c9668bdd5ad7cf3cadafd5/HLS_VMAP/AppleHLS1/flame-bao.2018.1080p.bluray.x264.m3u8?ads.cue=start,120000&ads.site=356853&ads.page=1469316&ads.fmt=29827&ads.vast=vast3&ads.ssar=0&ads.ps=&ads.madb=30&ads.referer=&ads.appname=&ads.buid=&ads.srl=&ads.uid=&ads.ifa=&ads.ua=&ads.ctt=&ads.ctc=&ads.ctd=&ads.gdpr=&aws.logMode=DEBUG">HLS - SSAI - Flame Bao</option>
                        <option value="https://d9g2cvf59hfzx.cloudfront.net/v1/master/36e2f8afe48d8956c4c9668bdd5ad7cf3cadafd5/HLS_VMAP/AppleHLS2/The_Crush_VOD.m3u8?ads.cue=start,120000&ads.site=356853&ads.page=1469316&ads.fmt=29827&ads.vast=vast3&ads.ssar=0&ads.ps=&ads.madb=30&ads.referer=&ads.appname=&ads.buid=&ads.srl=&ads.uid=&ads.ifa=&ads.ua=&ads.ctt=&ads.ctc=&ads.ctd=&ads.gdpr=&aws.logMode=DEBUG">HLS - SSAI - The Crush</option>
                        <option value="https://d15xxd9pv2ecav.cloudfront.net/v1/dash/36e2f8afe48d8956c4c9668bdd5ad7cf3cadafd5/DASH_VMAP/DASH06/flame_bao.mpd?ads.cue=start,120000&ads.site=356853&ads.page=1469316&ads.fmt=29827&ads.vast=vast3&ads.ssar=0&ads.ps=&ads.madb=30&ads.referer=&ads.appname=&ads.buid=&ads.srl=&ads.uid=&ads.ifa=&ads.ua=&ads.ctt=&ads.ctc=&ads.ctd=&ads.gdpr=&aws.logMode=DEBUG">DASH - SSAI - Flame Bao</option>
                        <option value="https://d15xxd9pv2ecav.cloudfront.net/v1/dash/36e2f8afe48d8956c4c9668bdd5ad7cf3cadafd5/DASH_VMAP/DASH09/The_Crush_VOD.mpd?ads.cue=start,120000&ads.site=356853&ads.page=1469316&ads.fmt=29827&ads.vast=vast3&ads.ssar=0&ads.ps=&ads.madb=30&ads.referer=&ads.appname=&ads.buid=&ads.srl=&ads.uid=&ads.ifa=&ads.ua=&ads.ctt=&ads.ctc=&ads.ctd=&ads.gdpr=&aws.logMode=DEBUG">DASH - SSAI - The Crush</option>
                    </optgroup>
                    <optgroup label="Live Stream ing">
                      <option value="Not Available">Live HLS</option>
                      <option value="https://f2414d8345454f6d1beb920b989cd322.7wzuvg.channel-assembly.mediatailor.us-east-1.amazonaws.com/v1/channel/Smart_1/index.mpd">Live DASH (No Ad)</option>
                  <optgroup label="Custom Streaming URL">
                      <option>User Input</option>
                  </optgroup>
                </select>
                <div class="listDetails" style="display:none;"></div>
            </div>
            <div class="sectionStream" style="display:none;">
                <div class="description">
                    2. Customise ADS parameters    
                </div>
                <div class="Form">
                    <form>
                        <div>
                            <textarea></textarea>
                        </div>
                    </form>
                <button class="btn" onclick="handleVideoStreamConf()">Load Streaming Configuration</button>
                </div>
            </div>
        </div>
        <div class="playerContainer">
            <div class="playerPanel" style="display:none;">
               <video class="playerPanel" id="videoPlayer" controls></video>
            </div> 
        </div>
        <script type="text/javascript">
            // Handle list selection
            var myDivSection = document.getElementsByClassName("sectionStream")[0];
            var myDivStreamUrl = document.getElementsByTagName("textarea")[0];
            var myDivListDetails = document.getElementsByClassName("listDetails")[0];
            document.getElementById("streamSelect").onchange = function(){
                myDivSection.style.display = (this.selectedIndex != 0) ? "block" : "none";
                myDivStreamUrl.value = this.options[this.selectedIndex].value;
                if ([1].includes(this.selectedIndex)) { 
                    myDivListDetails.style.display = "block";
                    myDivListDetails.innerHTML = "<b>Ad Avails:</b> T0 (preroll) - T120 (midroll) <br><b>Ad Details:</b> Defined based on stream request parameters below";
                }
                else if ([2].includes(this.selectedIndex)) { 
                    myDivListDetails.style.display = "block";
                    myDivListDetails.innerHTML = "<b>Ad Avails:</b> T0 (preroll) - T120 (midroll) <br><b>Ad Details:</b> Defined based on stream request parameters below";
                }
                else if ([3].includes(this.selectedIndex)) { 
                    myDivListDetails.style.display = "block";
                    myDivListDetails.innerHTML = "<b>Ad Avails:</b> T0 (preroll) <br><b>Ad Details:</b> Defined based on stream request parameters below";
                }
                else if ([4].includes(this.selectedIndex)) { 
                    myDivListDetails.style.display = "block";
                    myDivListDetails.innerHTML = "<b>Ad Avails:</b> T0 (preroll) <br><b>Ad Details:</b> Defined based on stream request parameters below";
                }
                else if ([5].includes(this.selectedIndex)) { 
                    myDivListDetails.style.display = "block";
                    myDivListDetails.innerHTML = "<b>Ad Avails:</b> VMAP Cue Points in Stream Request<br><b>Ad Details:</b> Defined based on stream request parameters below";
                }
                else if ([6].includes(this.selectedIndex)) { 
                    myDivListDetails.style.display = "block";
                    myDivListDetails.innerHTML = "<b>Ad Avails:</b> VMAP Cue Points in Stream Request<br><b>Ad Details:</b> Defined based on stream request parameters below";
                }
                else if ([7].includes(this.selectedIndex)) { 
                    myDivListDetails.style.display = "block";
                    myDivListDetails.innerHTML = "<b>Ad Avails:</b> VMAP Cue Points in Stream Request<br><b>Ad Details:</b> Defined based on stream request parameters below";
                }
                else if ([8].includes(this.selectedIndex)) { 
                    myDivListDetails.style.display = "block";
                    myDivListDetails.innerHTML = "<b>Ad Avails:</b> VMAP Cue Points in Stream Request<br><b>Ad Details:</b> Defined based on stream request parameters below";
                }
                else {
                    myDivListDetails.style.display = "none";
                    myDivListDetails.innerHTML = "";
                }
            }
        </script>
        <script type="text/javascript">
            var DASHplayer;
            var HLSplayer;

            // Function to load DASH player
            function invokeDASHVideoPlayer(streamUrl){
                DASHplayer = dashjs.MediaPlayer().create();
                DASHplayer.initialize(document.querySelector("#videoPlayer"), streamUrl, false);
                // DASHplayer.setAutoPlay(false);
            }

            // Function to load HLS player
            function invokeHLSVideoPlayer(streamUrl){
                  if (Hls.isSupported()) {
                    var config = {
                        autoStartLoad: true,
                        startPosition: -1,
                        debug: false,
                        };
                    HLSplayer = new Hls(config);
                    // bind them together
                    HLSplayer.attachMedia(document.querySelector("#videoPlayer"));
                    HLSplayer.on(Hls.Events.MEDIA_ATTACHED, function () {
                      console.log('video and hls.js are now bound together !');
                      HLSplayer.loadSource(streamUrl);
                      HLSplayer.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                        console.log(
                          'manifest loaded, found ' + data.levels.length + ' quality level'
                        );
                      });
                    });
                  }
            }

            // Function to Clear any existing player and create new conditions
            function preparePlayer(streamMime, playerExists){
                if (playerExists) {
                    console.log('player already exists. Remove and prepare new player');
                    // Remove existing player DOM elements
                    existingPlayer = document.getElementsByClassName("playerPanel")[0].firstElementChild;
                    existingPlayer.remove();
                    // Check player in use and Destroy
                    (DASHplayer) ? DASHplayer.destroy() : (HLSplayer) ? HLSplayer.destroy() : alert("Undefined situation. l.140");
                    // Prepare new player
                    PlayerNew = document.createElement("video");
                    PlayerNew.setAttribute("class","playerPanel");PlayerNew.setAttribute("id","videoPlayer");PlayerNew.setAttribute("controls","");
                    document.getElementsByClassName("playerPanel")[0].appendChild(PlayerNew);
                }
                else {
                    // Remove "display:none" attribute from player div
                    document.getElementsByClassName("playerPanel")[0].removeAttribute("style");
                }
            }

            function handleVideoStreamConf() {
                // Get stream URL from user input
                streamUrl = document.getElementsByTagName("textarea")[0].value;
                streamUrl = streamUrl.replaceAll("&amp;", "&");
                // Update Main site URL query param
                if (history.pushState) {
                    var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?StreamRequest='+ encodeURIComponent(streamUrl);
                    window.history.pushState({path:newurl},'',newurl);
                }
                // Define stream mime type HLS or DASH
                streamMime = (streamUrl.match('.*m3u8')) ? "application/x-mpegurl" : "application/dash+xml";
                // Check if player is already exists
                playerExists = (document.getElementsByClassName("playerPanel")[0].style[0] == 'display') ? false:true;
                // Prepare player conditions
                preparePlayer(streamMime,playerExists);
                // Load correct player based on MIME type
                (streamMime == "application/dash+xml") ? invokeDASHVideoPlayer(streamUrl):invokeHLSVideoPlayer(streamUrl);
            }

            function handleStreamRequestURLinQueryStringParam() {
                URLParams = new URLSearchParams(window.location.search);
                StreamRequest = URLParams.get("StreamRequest");
                if (StreamRequest.length > 0) {
                    // Select user input option list
                    document.getElementById("streamSelect")[11].selected = 'selected'
                    // Un hide url text area
                    myDivSection.style.display = "block";
                    // Fill text area with stream request from URL query string param
                    myDivStreamUrl.value=StreamRequest;
                }
            }


            // Listen to page load event to process any stream request passed directly in the URL
            window.addEventListener('load', (event) => {
                console.log('page is fully loaded');
                handleStreamRequestURLinQueryStringParam();
            });    
        </script>
        <!-- Load DASH.JS library  -->
        <script src="https://cdn.dashjs.org/latest/dash.all.debug.js"></script>
        <!-- Load HLS.JS Library -->
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    </body>
</html>
